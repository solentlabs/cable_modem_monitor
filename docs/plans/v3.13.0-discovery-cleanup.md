# v3.12.0 Discovery Cleanup Plan

> **Status**: DEFERRED
> **Date**: 2026-01-17
> **Reason**: Over-engineering risk. Existing infrastructure (adapter, modem.yaml capabilities) already handles these concerns. See journal entry 2026-01-17.

## Overview

Clean up discovery pipeline and improve modem capability flow after v3.12.0 architecture changes.

## Issues to Address

### 1. Discovery Session Cleanup

**Problem**: Discovery pipeline leaves session open after validation.

**Current flow**:
1. Discovery authenticates, validates parser
2. Session stored in `DiscoveryPipelineResult.session`
3. Pipeline returns, session left dangling
4. Setup creates new scraper, authenticates again

**Fix**:
- After validation step, call modem's logout URL if available
- Then close the session
- Location: `core/discovery/pipeline.py` after step 4 completes

**Code sketch**:
```python
# After validation succeeds
if result.session and result.auth_config:
    logout_url = result.auth_config.get("logout_url")
    if logout_url:
        try:
            result.session.get(urljoin(result.working_url, logout_url))
        except Exception:
            pass  # Best effort
    result.session.close()
```

### 2. Pre-Auth HTML in Resources

**Problem**: Initial "/" resource is pre-auth login page when modem requires authentication.

**Current flow** (`modem_scraper.py:1393-1421`):
1. `_fetch_data()` returns initial HTML (may be login page)
2. `_login()` authenticates
3. Loader fetches modem.yaml resources
4. Initial HTML added as "/" resource â†’ parser receives useless login page

**Fix options**:
- **Option A**: Don't add "/" if we authenticated (it's the login page)
- **Option B**: Re-fetch base URL after auth, use that as "/"
- **Option C**: Only add "/" if it wasn't a login page (check `is_login_page()`)

**Recommendation**: Option C - most accurate. Only include "/" if it has useful content.

**Code sketch**:
```python
# In _parse_data()
resources = loader.fetch(session)

# Only include initial HTML if it's not a login page
if initial_html and not self._is_login_page(initial_html):
    resources["/"] = BeautifulSoup(initial_html, "html.parser")
```

### 3. Modem Capabilities Flow

**Problem**: Button platform reloads parser to check restart support. Modem info should flow downstream, not be re-discovered.

**Current flow**:
1. Discovery determines parser, auth, capabilities
2. Config entry stores basic info
3. Button setup calls `get_parser_by_name()` to check `hasattr(parser, "restart")`

**Fix**: Establish modem capabilities during discovery, store in config entry, pass to components.

**New data structure**:
```python
# In config entry data
CONF_MODEM_CAPABILITIES = "modem_capabilities"

# Structure
modem_capabilities = {
    "supports_restart": True,
    "supports_logout": True,
    "logout_url": "/logout.asp",
    "restart_method": "post",  # or "hnap", "api", etc.
}
```

**Discovery changes** (`core/discovery/steps.py`):
```python
def _extract_capabilities(parser_class, modem_config) -> dict:
    """Extract modem capabilities from parser and config."""
    return {
        "supports_restart": hasattr(parser_class, "restart"),
        "supports_logout": bool(modem_config.get("auth", {}).get("logout_url")),
        "logout_url": modem_config.get("auth", {}).get("logout_url"),
    }
```

**Button changes** (`button.py`):
```python
async def _check_restart_support(hass, entry) -> bool:
    # Just read from config entry - no parser loading needed
    capabilities = entry.data.get(CONF_MODEM_CAPABILITIES, {})
    return capabilities.get("supports_restart", False)
```

**Scraper changes**: Use capabilities for logout after polling:
```python
def _logout(self):
    capabilities = self._modem_capabilities
    if capabilities.get("supports_logout") and capabilities.get("logout_url"):
        self._session.get(urljoin(self._base_url, capabilities["logout_url"]))
```

## Implementation Order

1. **Issue 3 first** - Establish capabilities structure, flows naturally to issues 1 and 2
2. **Issue 1 second** - Use capabilities for proper logout in discovery
3. **Issue 2 last** - Clean up resource handling

## Migration

- Existing config entries won't have `modem_capabilities`
- Fallback: if not present, derive from parser at runtime (current behavior)
- New installs get capabilities populated during discovery

## Testing

- Test discovery logout on modems with/without logout support
- Test button availability reads from capabilities
- Test pre-auth login page not passed to parser
- Test existing config entries still work (graceful fallback)

## Files to Modify

- `core/discovery/pipeline.py` - Session cleanup
- `core/discovery/steps.py` - Extract capabilities
- `core/modem_scraper.py` - Use capabilities for logout, fix "/" resource
- `config_flow.py` - Store capabilities in config entry
- `button.py` - Read capabilities instead of loading parser
- `const.py` - Add `CONF_MODEM_CAPABILITIES`
